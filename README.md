# Sistema de Escrow con Aprobaci√≥n T√°cita para Servicios Profesionales

## üìã Tabla de Contenidos

1. [Resumen Ejecutivo](#resumen-ejecutivo)
2. [Innovaci√≥n Tecnol√≥gica](#innovaci√≥n-tecnol√≥gica)
3. [Arquitectura del Sistema](#arquitectura-del-sistema)
4. [Contratos Inteligentes](#contratos-inteligentes)
5. [Flujo de Uso T√©cnico](#flujo-de-uso-t√©cnico)
6. [Ejemplos Pr√°cticos](#ejemplos-pr√°cticos)
7. [Ventajas de Negocio](#ventajas-de-negocio)
8. [Desarrollo y Testing](#desarrollo-y-testing)

---

## üéØ Resumen Ejecutivo

Sistema de smart contracts para facilitar transacciones seguras entre Pymes y Expertos/Freelancers con:

- ‚úÖ **Liberaci√≥n progresiva por milestones** (hitos de trabajo)
- ‚úÖ **Aprobaci√≥n t√°cita autom√°tica** (timeout configurable, por defecto 8 d√≠as)
- ‚úÖ **Protecci√≥n para ambas partes** (Pyme puede rechazar entregas, Experto recibe pago garantizado)
- ‚úÖ **Anticipo autom√°tico** al aceptar el contrato
- ‚úÖ **Comisi√≥n de plataforma** cobrada una sola vez al inicio
- ‚úÖ **Cancelaci√≥n segura** antes de activaci√≥n (reembolso 100%)
- ‚úÖ **Transparencia total on-chain** con eventos auditables
- ‚úÖ **Eficiencia de gas** mediante patr√≥n Factory (EIP-1167 Clone)

### Caracter√≠sticas Clave

- **Patr√≥n Factory**: Uso de EIP-1167 (Minimal Proxy/Clone) para eficiencia de gas (~90% de ahorro en deployment)
- **Proceso en dos pasos**: `initialize()` crea el escrow, `fund()` deposita fondos (soluciona problema de allowance)
- **Aprobaci√≥n t√°cita**: Si la Pyme no revisa en `revisionPeriod` d√≠as, el milestone se aprueba autom√°ticamente
- **Seguridad**: Separaci√≥n de roles (Pyme, Experto, Admin) con control de acceso granular
- **Flexibilidad**: Per√≠odo de revisi√≥n configurable por escrow

---

## ÔøΩÔøΩ Innovaci√≥n Tecnol√≥gica

### Diferencias Clave con Sistemas Tradicionales de Escrow

| Aspecto | Escrow Tradicional | Sistema Blockchain Ivestingo |
|---------|-------------------|------------------------------|
| **Intermediario** | Tercero de confianza (banco, notario) | Smart contract (c√≥digo auditable) |
| **Costo de intermediaci√≥n** | 5-10% + fees fijos | 3-5% (configurable) |
| **Tiempo de liberaci√≥n** | 3-7 d√≠as h√°biles | Instant√°neo (al aprobar/timeout) |
| **Transparencia** | Limitada, opaca | Total, todo on-chain verificable |
| **Aprobaci√≥n t√°cita** | No existe | Autom√°tica tras per√≠odo configurable |
| **Cancelaci√≥n** | Requiere aprobaci√≥n de ambas partes | Autom√°tica antes de activaci√≥n |
| **Disputa** | Proceso legal costoso | Ciclo de rechazo/reentrega en contrato |
| **Auditor√≠a** | Manual, costosa | Autom√°tica, on-chain |

### Optimizaci√≥n de Tiempos

```
PROCESO TRADICIONAL:
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Crear escrow (3 d√≠as) ‚Üí Dep√≥sito (2 d√≠as) ‚Üí               ‚îÇ
‚îÇ ‚Üí Entrega (N d√≠as) ‚Üí Revisi√≥n (7 d√≠as) ‚Üí                  ‚îÇ
‚îÇ ‚Üí Aprobaci√≥n manual (3 d√≠as) ‚Üí Liberaci√≥n (5 d√≠as)        ‚îÇ
‚îÇ = 20+ d√≠as por milestone                                   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

PROCESO BLOCKCHAIN IVESTINGO:
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ deployEscrow (1 tx, ~3 min) ‚Üí fund (1 tx, ~3 min) ‚Üí       ‚îÇ
‚îÇ ‚Üí acceptContract (1 tx, anticipo liberado instant√°neo) ‚Üí   ‚îÇ
‚îÇ ‚Üí deliverMilestone ‚Üí aprobaci√≥n t√°cita (8 d√≠as) o manual  ‚îÇ
‚îÇ = 8 d√≠as promedio por milestone (60% reducci√≥n)           ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

‚ö° REDUCCI√ìN: 60% en tiempo promedio por milestone
```

### Flujo de Aprobaci√≥n Inteligente

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ              MECANISMO DE APROBACI√ìN T√ÅCITA                 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

Experto ‚Üí deliverMilestone()
   ‚îÇ
   ‚îî‚îÄ> timestamp capturado = block.timestamp
        ‚îÇ
        ‚îú‚îÄ> OPCI√ìN 1: Pyme aprueba directamente
        ‚îÇ    ‚îî‚îÄ> approveMilestone() ‚Üí Liberaci√≥n inmediata
        ‚îÇ
        ‚îú‚îÄ> OPCI√ìN 2: Pyme rechaza
        ‚îÇ    ‚îî‚îÄ> rejectMilestone() ‚Üí Estado vuelve a InProgress
        ‚îÇ         ‚îî‚îÄ> timestamp reiniciado a 0
        ‚îÇ              ‚îî‚îÄ> Experto debe volver a entregar
        ‚îÇ
        ‚îî‚îÄ> OPCI√ìN 3: Pyme no act√∫a en revisionPeriod (8 d√≠as)
             ‚îî‚îÄ> Cualquiera llama checkTacitApproval()
                  ‚îî‚îÄ> Liberaci√≥n autom√°tica

‚ö° INNOVACI√ìN: Protege al Experto de Pymes morosas sin quitar
               control de calidad a la Pyme
```

---

## üèóÔ∏è Arquitectura del Sistema

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                     ARQUITECTURA T√âCNICA                     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

EscrowFactory (F√°brica de Escrows)
  ‚îÇ
  ‚îÇ FUNCI√ìN: deployEscrow(...)
  ‚îÇ ‚îî‚îÄ Clona Escrow (EIP-1167 Clone, ahorro ~90% gas)
  ‚îÇ
  ‚îî‚îÄ‚îÄ> Escrow #1 (Instancia √∫nica)
        ‚îÇ - addressPyme: Wallet de la Pyme/Cliente
        ‚îÇ - addressExpert: Wallet del Experto/Freelancer
        ‚îÇ - addressAdmin: Admin de plataforma (recibe fees)
        ‚îÇ - addressBaseToken: Token de pago (USDC/MockERC20)
        ‚îÇ
        ‚îú‚îÄ Estado: Created ‚Üí Funded ‚Üí Active ‚Üí Completed/Cancelled
        ‚îÇ
        ‚îú‚îÄ Milestones:
        ‚îÇ   ‚îú‚îÄ milestoneDescriptions[id] = descripci√≥n
        ‚îÇ   ‚îú‚îÄ milestoneAmounts[id] = monto en baseToken
        ‚îÇ   ‚îú‚îÄ milestoneStatuses[id] = InProgress/Delivered/Approved
        ‚îÇ   ‚îî‚îÄ milestoneDeliveryTimestamps[id] = timestamp de entrega
        ‚îÇ
        ‚îî‚îÄ Flujo:
             1. Pyme ‚Üí deployEscrow() en Factory
             2. Pyme ‚Üí approve() baseToken al Escrow clonado
             3. Pyme ‚Üí fund() (deposita 100% de fondos)
             4. Experto ‚Üí acceptContract() (recibe anticipo + activa)
             5. Loop por cada milestone:
                a. Experto ‚Üí deliverMilestone()
                b. Pyme ‚Üí approveMilestone() O rejectMilestone()
                   O Cualquiera ‚Üí checkTacitApproval() (tras timeout)
             6. √öltimo milestone aprobado ‚Üí Estado Completed
```

### Estados del Escrow

```solidity
enum EscrowStatus {
    Created,     // Escrow creado, esperando fondos
    Funded,      // Fondos depositados, esperando aceptaci√≥n del Experto
    Active,      // Experto acept√≥, anticipo liberado, trabajando en milestones
    Completed,   // Todos los milestones aprobados
    Cancelled    // Cancelado por Pyme antes de Funded‚ÜíActive
}
```

### Estados de Milestones

```solidity
enum MilestoneStatus {
    InProgress,  // Milestone en progreso (Experto trabajando)
    Delivered,   // Experto entreg√≥, esperando revisi√≥n
    Approved     // Aprobado (directamente o por timeout), fondos liberados
}
```

---

## üìú Contratos Inteligentes

### 1. EscrowFactory.sol

**Prop√≥sito**: F√°brica para desplegar escrows usando clonado (EIP-1167).

**Variables Inmutables**:
```solidity
address public immutable escrowImplementation;  // Implementaci√≥n base de Escrow
```

**Variables de Estado**:
```solidity
address public admin;                          // Admin de la plataforma
address[] public escrows;                      // Todos los escrows desplegados
mapping(address => address[]) public pymeEscrows;    // Escrows por Pyme
mapping(address => address[]) public expertEscrows;  // Escrows por Experto
```

**Funciones Principales**:

#### `deployEscrow(...)`
Crea un nuevo escrow clonando la implementaci√≥n.

**Par√°metros**:
```solidity
function deployEscrow(
    address _addressPyme,                    // Wallet de la Pyme/Cliente
    address _addressBaseToken,               // Token de pago (USDC/MockERC20)
    address _addressExpert,                  // Wallet del Experto/Freelancer
    uint256 _totalMilestonesAmount,          // Monto total del contrato
    string[] memory _milestoneDescriptions,  // ["Dise√±o UI", "Backend API", ...]
    uint256[] memory _milestoneAmounts,      // [3000, 5000, 2000] en baseToken
    uint256 _revisionPeriod,                 // Per√≠odo de revisi√≥n en segundos (ej: 691200 = 8 d√≠as)
    uint256 _platformFee                     // Fee en basis points (500 = 5%)
) external returns (address)
```

**Validaciones**:
- Arrays deben tener la misma longitud
- `sum(_milestoneAmounts) == _totalMilestonesAmount`

**Retorna**:
- `address`: Direcci√≥n del contrato Escrow clonado

**Eventos**:
```solidity
event EscrowDeployed(
    address indexed escrowAddress,
    address indexed pyme,
    address indexed expert,
    uint256 totalAmount
);
```

**Flujo interno**:
1. Clona `escrowImplementation` (EIP-1167)
2. Inicializa el clon con `Escrow.initialize(...)`
3. Registra en `escrows`, `pymeEscrows` y `expertEscrows`
4. Emite evento `EscrowDeployed`

#### Funciones de Consulta

```solidity
function getEscrows() external view returns (address[] memory);
function getPymeEscrows(address _pyme) external view returns (address[] memory);
function getExpertEscrows(address _expert) external view returns (address[] memory);
function getTotalEscrows() external view returns (uint256);
```

---

### 2. Escrow.sol

**Prop√≥sito**: Contrato individual que gestiona un escrow de servicios profesionales.

**Variables de Configuraci√≥n**:
```solidity
EscrowStatus public status;
bool private initialized;
uint256 public totalMilestonesAmount;          // Monto total del contrato
uint256 public totalMilestones;                // N√∫mero de milestones
uint256 public currentMilestone;               // Milestone actual (siguiente a completar)
uint256 public revisionPeriod;                 // Per√≠odo de revisi√≥n en segundos
uint256 public platformFee;                    // Fee en basis points (500 = 5%)
```

**Direcciones**:
```solidity
address public addressPyme;                    // Wallet de la Pyme/Cliente
address public addressExpert;                  // Wallet del Experto/Freelancer
address public addressAdmin;                   // Admin/Plataforma (recibe fees)
address public addressBaseToken;               // Token de pago (USDC/MockERC20)
```

**Tracking de Milestones**:
```solidity
mapping(uint256 => string) public milestoneDescriptions;
mapping(uint256 => uint256) public milestoneAmounts;
mapping(uint256 => MilestoneStatus) public milestoneStatuses;
mapping(uint256 => uint256) public milestoneDeliveryTimestamps;
```

#### Funciones Principales

##### `initialize(...)`
Inicializa una instancia clonada (llamada por `EscrowFactory`). **NO transfiere fondos**.

**Validaciones**:
- No puede ser inicializado dos veces
- Todas las direcciones deben ser v√°lidas (‚â† address(0))
- Arrays de milestones deben tener la misma longitud
- Al menos un milestone requerido
- `platformFee <= 10000` (100%)
- **CR√çTICO**: `sum(milestoneAmounts) == totalMilestonesAmount`

**Efectos**:
- Establece todas las variables de estado
- `addressAdmin = msg.sender` (Factory)
- Estado ‚Üí `Created`
- Emite `EscrowCreated`

---

##### `fund()`
La Pyme deposita el 100% de los fondos en el escrow.

**Requisitos**:
- `msg.sender == addressPyme` (solo la Pyme)
- Estado `Created`
- Pyme debe haber aprobado `totalMilestonesAmount` de `baseToken` al contrato

**Efectos**:
1. Transfiere `totalMilestonesAmount` de `baseToken` al contrato
2. Estado ‚Üí `Funded`
3. Emite `EscrowFunded`

**Eventos**:
```solidity
emit EscrowFunded(addressPyme, totalMilestonesAmount);
```

**Nota Importante**: Este paso separado soluciona el problema de allowance, ya que el Escrow clonado tiene una direcci√≥n que solo se conoce DESPU√âS de ser creado.

---

##### `acceptContract()`
El Experto acepta el contrato, activando el escrow y recibiendo el anticipo (milestone 0).

**Requisitos**:
- `msg.sender == addressExpert` (solo el Experto)
- Estado `Funded`

**L√≥gica de Pago**:

```solidity
// 1. Cobra comisi√≥n total de plataforma (UNA SOLA VEZ)
uint256 totalPlatformFee = (totalMilestonesAmount * platformFee) / 10000;
IERC20(addressBaseToken).transfer(addressAdmin, totalPlatformFee);

// 2. Libera anticipo (milestone 0) al Experto
//    NOTA: Ya se descont√≥ la comisi√≥n total, aqu√≠ NO se descuenta de nuevo
uint256 milestone0Amount = milestoneAmounts[0];
IERC20(addressBaseToken).transfer(addressExpert, milestone0Amount);

// 3. Marca milestone 0 como Approved
milestoneStatuses[0] = MilestoneStatus.Approved;

// 4. Avanza al siguiente milestone (si hay m√°s)
if (totalMilestones > 1) {
    currentMilestone = 1;
    status = EscrowStatus.Active;
} else {
    status = EscrowStatus.Completed;
}
```


**Eventos**:
```solidity
emit EscrowActivated(addressExpert, milestone0Amount, totalPlatformFee);
emit PaymentReleased(addressExpert, milestone0Amount);
emit MilestoneApproved(0, milestone0Amount, false);
```

---

##### `deliverMilestone()`
El Experto marca un milestone como entregado, capturando el timestamp.

**Requisitos**:
- `msg.sender == addressExpert` (solo el Experto)
- Estado `Active`
- `currentMilestone < totalMilestones`
- `milestoneStatuses[currentMilestone] == InProgress`

**Efectos**:
1. `milestoneStatuses[currentMilestone] = Delivered`
2. `milestoneDeliveryTimestamps[currentMilestone] = block.timestamp`
3. Emite `MilestoneDelivered`

**Eventos**:
```solidity
emit MilestoneDelivered(currentMilestone, block.timestamp);
```

**Nota**: A partir de este momento, la Pyme tiene `revisionPeriod` segundos para revisar antes de que se active la aprobaci√≥n t√°cita.

---

##### `approveMilestone()`
La Pyme aprueba directamente un milestone, liberando fondos al Experto.

**Requisitos**:
- `msg.sender == addressPyme` (solo la Pyme)
- Estado `Active`
- `milestoneStatuses[currentMilestone] == Delivered`

**Efectos**:
- Llama internamente a `_releaseMilestonePayment(currentMilestone, false)`

---

##### `checkTacitApproval()`
Cualquiera puede llamar esta funci√≥n para verificar si el per√≠odo de revisi√≥n expir√≥ y aprobar t√°citamente.

**Requisitos**:
- Estado `Active`
- `milestoneStatuses[currentMilestone] == Delivered`
- `milestoneDeliveryTimestamps[currentMilestone] > 0`
- `block.timestamp >= deliveryTimestamp + revisionPeriod`

**Efectos**:
- Llama internamente a `_releaseMilestonePayment(currentMilestone, true)`

**Nota**: Esta funci√≥n permite que el Experto (o cualquiera) fuerce la aprobaci√≥n si la Pyme no revisa a tiempo.

---

##### `_releaseMilestonePayment(uint256 milestoneId, bool isTacit)` (Privada)
Funci√≥n interna que libera fondos del milestone al Experto.

**L√≥gica**:
```solidity
uint256 milestoneAmount = milestoneAmounts[milestoneId];
uint256 proportionalFee = (milestoneAmount * platformFee) / 10000;
uint256 netPayment = milestoneAmount - proportionalFee;

IERC20(addressBaseToken).transfer(addressExpert, netPayment);

milestoneStatuses[milestoneId] = MilestoneStatus.Approved;

if (currentMilestone == totalMilestones - 1) {
    status = EscrowStatus.Completed;
} else {
    currentMilestone++;
}
```

**Eventos**:
```solidity
emit MilestoneApproved(milestoneId, netPayment, isTacit);
emit PaymentReleased(addressExpert, netPayment);
emit EscrowCompleted(); // Si es el √∫ltimo milestone
```

**Nota sobre comisi√≥n**: La comisi√≥n de plataforma se cobra una √∫nica vez al inicio del contrato. Los pagos posteriores de milestones no descuentan comisi√≥n adicional.

---

##### `rejectMilestone()`
La Pyme rechaza un milestone, devolvi√©ndolo a estado `InProgress` y reiniciando el timestamp.

**Requisitos**:
- `msg.sender == addressPyme` (solo la Pyme)
- Estado `Active`
- `milestoneStatuses[currentMilestone] == Delivered`

**Efectos**:
1. `milestoneStatuses[currentMilestone] = InProgress`
2. `milestoneDeliveryTimestamps[currentMilestone] = 0` (reinicia contador)
3. Emite `MilestoneRejected`

**Eventos**:
```solidity
emit MilestoneRejected(currentMilestone);
```

**Nota**: El Experto debe volver a llamar `deliverMilestone()` despu√©s de corregir el trabajo.

---

##### `cancelContract()`
La Pyme cancela el contrato ANTES de que el Experto lo acepte, recibiendo reembolso completo.

**Requisitos**:
- `msg.sender == addressPyme` (solo la Pyme)
- Estado `Funded` (despu√©s de `fund()`, antes de `acceptContract()`)

**Efectos**:
1. Transfiere `totalMilestonesAmount` de vuelta a la Pyme
2. Estado ‚Üí `Cancelled`
3. Emite `EscrowCancelled`

**Eventos**:
```solidity
emit EscrowCancelled(addressPyme, totalMilestonesAmount);
```

**Nota**: NO se cobra comisi√≥n en cancelaciones.

---

##### Funciones de Consulta

```solidity
function getMilestone(uint256 milestoneId) public view returns (Milestone memory);
function getEscrowStatus() public view returns (EscrowStatus);
```

**Struct Milestone**:
```solidity
struct Milestone {
    string description;
    uint256 amount;
    MilestoneStatus status;
    uint256 deliveryTimestamp;
}
```

---

### 3. EscrowInterface.sol

**Prop√≥sito**: Define la interfaz completa del sistema de escrow con eventos y structs.

**Eventos Principales**:
```solidity
event EscrowCreated(address indexed pyme, address indexed expert, uint256 totalAmount);
event EscrowFunded(address indexed pyme, uint256 amount);
event EscrowActivated(address indexed expert, uint256 advancePayment, uint256 platformFee);
event MilestoneDelivered(uint256 indexed milestoneId, uint256 timestamp);
event MilestoneApproved(uint256 indexed milestoneId, uint256 amount, bool tacit);
event MilestoneRejected(uint256 indexed milestoneId);
event PaymentReleased(address indexed expert, uint256 amount);
event EscrowCompleted();
event EscrowCancelled(address indexed pyme, uint256 refundAmount);
```

---

## üîß Flujo de Uso T√©cnico

### Flujo Completo: Desde Deployment hasta Finalizaci√≥n

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ FASE 0: DEPLOYMENT INICIAL (Solo una vez por red)             ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

1. Deploy MockERC20 (o usar USDC en mainnet):
   forge create src/mocks/MockERC20.sol:MockERC20

2. Deploy EscrowFactory:
   forge create src/EscrowFactory.sol:EscrowFactory

   Resultado:
   - escrowImplementation desplegado autom√°ticamente
   - EscrowFactory listo para crear escrows

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ FASE 1: CREACI√ìN DE ESCROW (Por cada proyecto)                ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

3. Pyme llama EscrowFactory.deployEscrow(...):

   cast send <FACTORY_ADDRESS> \
     "deployEscrow(address,address,address,uint256,string[],uint256[],uint256,uint256)" \
     0x4Ac2bb44F3a89B13A1E9ce30aBd919c40CbA4385 \  # addressPyme
     0x6F13F39ea6B665A3AfCD4d02Cf27D881932C7238 \  # addressBaseToken (MockERC20)
     0x05703526dB38D9b2C661c9807367C14EB98b6c54 \  # addressExpert
     20000000000000 \                               # totalMilestonesAmount (20,000)
     '["terminar app indahouse","terminar smart contracts"]' \ # milestoneDescriptions
     '[3000000000000,17000000000000]' \            # milestoneAmounts [3000, 17000]
     691200 \                                       # revisionPeriod (8 d√≠as en segundos)
     500 \                                          # platformFee (5%)
     --rpc-url https://rpc-amoy.polygon.technology/ \
     --private-key <PYME_PRIVATE_KEY>

   Resultado:
   - Escrow clonado en <ESCROW_ADDRESS>
   - currentMilestone = 0, status = Created

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ FASE 2: FONDEO DEL ESCROW                                     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

4. Pyme aprueba tokens al Escrow clonado:

   cast send <MOCK_ERC20_ADDRESS> \
     "approve(address,uint256)" \
     <ESCROW_ADDRESS> \
     20000000000000 \                               # totalMilestonesAmount
     --rpc-url https://rpc-amoy.polygon.technology/ \
     --private-key <PYME_PRIVATE_KEY>

5. Pyme deposita fondos:

   cast send <ESCROW_ADDRESS> \
     "fund()" \
     --rpc-url https://rpc-amoy.polygon.technology/ \
     --private-key <PYME_PRIVATE_KEY>

   Efectos:
   - 20,000 tokens transferidos al Escrow
   - status ‚Üí Funded
   - Evento EscrowFunded emitido

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ FASE 3: ACTIVACI√ìN POR EL EXPERTO                             ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

6. Experto acepta el contrato:

   cast send <ESCROW_ADDRESS> \
     "acceptContract()" \
     --rpc-url https://rpc-amoy.polygon.technology/ \
     --private-key <EXPERT_PRIVATE_KEY>

   Efectos:
   - Comisi√≥n total: (20000 * 500) / 10000 = 1000 ‚Üí Admin
   - Anticipo: 3000 ‚Üí Experto (milestone 0)
   - milestoneStatuses[0] = Approved
   - currentMilestone = 1
   - status ‚Üí Active
   - Eventos: EscrowActivated, PaymentReleased, MilestoneApproved

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ FASE 4: CICLO DE MILESTONES                                   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

7. Experto entrega milestone 1:

   cast send <ESCROW_ADDRESS> \
     "deliverMilestone()" \
     --rpc-url https://rpc-amoy.polygon.technology/ \
     --private-key <EXPERT_PRIVATE_KEY>

   Efectos:
   - milestoneStatuses[1] = Delivered
   - milestoneDeliveryTimestamps[1] = block.timestamp (ej: 1735000000)
   - Evento MilestoneDelivered(1, 1735000000)

8. ESCENARIO A - Pyme aprueba directamente:

   cast send <ESCROW_ADDRESS> \
     "approveMilestone()" \
     --rpc-url https://rpc-amoy.polygon.technology/ \
     --private-key <PYME_PRIVATE_KEY>

   Efectos:
   - Pago: 17000 - (17000 * 500 / 10000) = 16150 ‚Üí Experto
   - milestoneStatuses[1] = Approved
   - currentMilestone = 2 (== totalMilestones)
   - status ‚Üí Completed
   - Eventos: MilestoneApproved(1, 16150, false), PaymentReleased, EscrowCompleted

9. ESCENARIO B - Pyme rechaza:

   cast send <ESCROW_ADDRESS> \
     "rejectMilestone()" \
     --rpc-url https://rpc-amoy.polygon.technology/ \
     --private-key <PYME_PRIVATE_KEY>

   Efectos:
   - milestoneStatuses[1] = InProgress
   - milestoneDeliveryTimestamps[1] = 0
   - Evento MilestoneRejected(1)
   - Experto debe volver al paso 7

10. ESCENARIO C - Aprobaci√≥n t√°cita (timeout):

    Despu√©s de 8 d√≠as (691200 segundos), cualquiera puede llamar:

    cast send <ESCROW_ADDRESS> \
      "checkTacitApproval()" \
      --rpc-url https://rpc-amoy.polygon.technology/ \
      --private-key <ANY_PRIVATE_KEY>

    Validaci√≥n interna:
    - block.timestamp >= 1735000000 + 691200 = 1735691200

    Efectos (iguales a ESCENARIO A, pero isTacit = true):
    - Pago: 16150 ‚Üí Experto
    - status ‚Üí Completed
    - Evento MilestoneApproved(1, 16150, true)

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ FASE 5 (ALTERNATIVA): CANCELACI√ìN ANTES DE ACTIVACI√ìN         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

Si la Pyme cambia de opini√≥n antes de que el Experto acepte:

11. Pyme cancela:

    cast send <ESCROW_ADDRESS> \
      "cancelContract()" \
      --rpc-url https://rpc-amoy.polygon.technology/ \
      --private-key <PYME_PRIVATE_KEY>

    Efectos:
    - 20,000 tokens ‚Üí Pyme (reembolso completo)
    - status ‚Üí Cancelled
    - Evento EscrowCancelled(pyme, 20000)
```

---

## üìä Ejemplos Pr√°cticos

### Contratos de Ejemplo (Testnet)

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ               DIRECCIONES DE EJEMPLO (Testnet)               ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

Admin/Owner:
  0x05703526dB38D9b2C661c9807367C14EB98b6c54

Pyme (Cliente):
  0x4Ac2bb44F3a89B13A1E9ce30aBd919c40CbA4385

Experto (Freelancer):
  0x05703526dB38D9b2C661c9807367C14EB98b6c54

EscrowFactory:
  0x... (Desplegar usando forge create)

MockERC20:
  0x... (Desplegar usando forge create)

RPC URL:
  https://rpc-amoy.polygon.technology/

Block Explorer:
  https://amoy.polygonscan.com/
```

### Ejemplo Completo: Proyecto "App Indahouse"

**Contexto**:
- Pyme contrata Experto para dos milestones:
  1. Terminar app indahouse (anticipo): 3,000 tokens
  2. Terminar smart contracts: 17,000 tokens
- Total: 20,000 tokens
- Comisi√≥n: 5% (1,000 tokens)
- Per√≠odo de revisi√≥n: 8 d√≠as

**Flujo**:

```bash
# 1. Deploy Factory y MockERC20
forge create src/EscrowFactory.sol:EscrowFactory --rpc-url <RPC> --private-key <KEY>
forge create src/mocks/MockERC20.sol:MockERC20 --rpc-url <RPC> --private-key <KEY>

# 2. Pyme mintea tokens (si MockERC20)
cast send <MOCK_ERC20> "mint(address,uint256)" <PYME_ADDRESS> 20000000000000 --rpc-url <RPC> --private-key <KEY>

# 3. Pyme crea escrow
cast send <FACTORY> "deployEscrow(...)" [par√°metros del ejemplo anterior]
# ‚Üí Resultado: ESCROW_ADDRESS = 0xABC...

# 4. Pyme aprueba y fondea
cast send <MOCK_ERC20> "approve(address,uint256)" 0xABC... 20000000000000 --rpc-url <RPC> --private-key <PYME_KEY>
cast send 0xABC... "fund()" --rpc-url <RPC> --private-key <PYME_KEY>

# 5. Experto acepta (recibe 3,000 de anticipo)
cast send 0xABC... "acceptContract()" --rpc-url <RPC> --private-key <EXPERT_KEY>

# Balance del Experto: 3,000 tokens
# Balance del Admin: 1,000 tokens (comisi√≥n)
# Balance del Escrow: 16,000 tokens (milestone 1 pendiente)

# 6. Experto entrega milestone 1
cast send 0xABC... "deliverMilestone()" --rpc-url <RPC> --private-key <EXPERT_KEY>

# 7a. Pyme aprueba (liberaci√≥n inmediata)
cast send 0xABC... "approveMilestone()" --rpc-url <RPC> --private-key <PYME_KEY>

# Balance final del Experto:
#   - Anticipo: 3,000
#   - Milestone 1: 17,000
#   - TOTAL: 20,000 tokens (antes de comisi√≥n)

# Balance final del Admin: 1,000 tokens (comisi√≥n de plataforma - 5%)
# Balance final del Experto: 19,000 tokens (despu√©s de comisi√≥n)
# Balance final del Escrow: 0 tokens
# Total distribuido: 19,000 + 1,000 = 20,000 tokens ‚úì
```

---

## üíº Ventajas de Negocio

### Para las Pymes

| Ventaja | Descripci√≥n | Impacto Cuantificado |
|---------|-------------|----------------------|
| **Protecci√≥n contra incumplimiento** | Fondos bloqueados hasta aprobaci√≥n | Riesgo de p√©rdida total eliminado |
| **Control de calidad** | Puede rechazar entregas deficientes | Poder de revisi√≥n ilimitado |
| **Aprobaci√≥n t√°cita** | Protecci√≥n contra Expertos morosos | No requiere acci√≥n si conforme |
| **Cancelaci√≥n segura** | Antes de activaci√≥n, reembolso 100% | Sin riesgo por cambio de planes |
| **Transparencia** | Todo on-chain, auditable | Confianza en el sistema |

### Para los Expertos/Freelancers

| Ventaja | Descripci√≥n | Impacto Cuantificado |
|---------|-------------|----------------------|
| **Anticipo garantizado** | Al aceptar, recibe milestone 0 | Liquidez inmediata |
| **Protecci√≥n contra morosidad** | Aprobaci√≥n t√°cita tras 8 d√≠as | Pago garantizado si entrega |
| **Transparencia de fondos** | Sabe que los fondos est√°n bloqueados | Confianza en el pago |
| **Menos fricci√≥n** | No requiere perseguir pagos | Ahorro de tiempo y estr√©s |

### Para la Plataforma

| Ventaja | Descripci√≥n | Impacto Cuantificado |
|---------|-------------|----------------------|
| **Escalabilidad** | Factory pattern permite escrows ilimitados | 0 costo marginal |
| **Automatizaci√≥n** | Smart contracts ejecutan reglas | Sin staff operativo |
| **Eficiencia de gas** | EIP-1167 Clone ahorra ~90% | De ~$100 a ~$10 (mainnet) |
| **Comisi√≥n garantizada** | Cobrada al inicio | No requiere perseguir pagos |

### Comparaci√≥n de Costos

**Ejemplo: Pyme contrata Experto por $10,000 con 3 milestones**

| Concepto | Escrow Tradicional | Sistema Blockchain | Ahorro |
|----------|-------------------|-------------------|--------|
| Fee de plataforma | 8% = $800 | 5% = $500 | **$300** |
| Tiempo de liberaci√≥n | 5 d√≠as por milestone | Instant√°neo | **15 d√≠as** |
| Costo de disputa | $500-$2000 | $0 (ciclo rechazo/reentrega) | **$500-$2000** |
| Transparencia | Opaca | Total | **Priceless** |

---

## üß™ Desarrollo y Testing

### Foundry - Setup

Este proyecto usa [Foundry](https://book.getfoundry.sh/) para desarrollo y testing.

#### Instalaci√≥n

```bash
curl -L https://foundry.paradigm.xyz | bash
foundryup
```

#### Comandos Principales

```bash
# Compilar contratos
forge build

# Ejecutar tests
forge test

# Ejecutar tests con verbosidad
forge test -vvv

# Gas report
forge test --gas-report

# Coverage
forge coverage

# Formatear c√≥digo
forge fmt

# Desplegar en local (Anvil)
anvil  # En terminal separado
forge script script/Deployment.s.sol:DeploymentScript --rpc-url http://localhost:8545 --broadcast

# Desplegar en testnet (Polygon Amoy)
forge script script/Deployment.s.sol:DeploymentScript \
  --rpc-url https://rpc-amoy.polygon.technology/ \
  --private-key $PRIVATE_KEY \
  --broadcast
```

### Estructura de Archivos

```
ivestingo-contracts-escrow/
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ Escrow.sol                      # Contrato de escrow individual
‚îÇ   ‚îú‚îÄ‚îÄ EscrowFactory.sol               # F√°brica de escrows (EIP-1167)
‚îÇ   ‚îî‚îÄ‚îÄ interfaces/
‚îÇ       ‚îî‚îÄ‚îÄ EscrowInterface.sol         # Interfaz con eventos y structs
‚îú‚îÄ‚îÄ test/
‚îÇ   ‚îú‚îÄ‚îÄ Escrow.t.sol                    # Tests del contrato Escrow
‚îÇ   ‚îú‚îÄ‚îÄ EscrowFactory.t.sol             # Tests de la f√°brica
‚îÇ   ‚îî‚îÄ‚îÄ mocks/
‚îÇ       ‚îî‚îÄ‚îÄ MockERC20.sol               # Mock para testing
‚îú‚îÄ‚îÄ script/
‚îÇ   ‚îî‚îÄ‚îÄ Deployment.s.sol                # Script de deployment
‚îú‚îÄ‚îÄ foundry.toml                        # Configuraci√≥n de Foundry
‚îú‚îÄ‚îÄ .data                               # Ejemplos de comandos cast
‚îî‚îÄ‚îÄ README.md                           # Esta documentaci√≥n
```

### Suite de Tests

El proyecto incluye una suite completa de tests unitarios y de integraci√≥n que cubren:

- Creaci√≥n de escrow via Factory
- Fondeo del escrow
- Aceptaci√≥n y liberaci√≥n de anticipo
- Entrega de milestones con timestamp
- Aprobaci√≥n directa de milestones
- Aprobaci√≥n t√°cita tras timeout
- Rechazo y reinicio de milestones
- Cancelaci√≥n antes de activaci√≥n
- Flujos completos con m√∫ltiples milestones
- Control de acceso por rol
- C√°lculo correcto de comisiones

---

## üîê Seguridad

### Roles y Permisos

| Rol | Permisos | Restricciones |
|-----|----------|---------------|
| **Pyme** | `fund()`, `approveMilestone()`, `rejectMilestone()`, `cancelContract()` | Solo antes/durante estados v√°lidos |
| **Experto** | `acceptContract()`, `deliverMilestone()` | Solo durante estados v√°lidos |
| **Admin** | Recibe comisi√≥n | Asignado en `initialize()` (Factory) |
| **Cualquiera** | `checkTacitApproval()`, `finalizeCampaign()` | Solo si se cumplen condiciones |

### Consideraciones de Seguridad

1. ‚úÖ **Reentrancy**: Uso de `IERC20` para transferencias seguras
2. ‚úÖ **Integer Overflow**: Solidity 0.8.30+ tiene protecci√≥n autom√°tica
3. ‚úÖ **Access Control**: Modificadores `require(msg.sender == ...)` en funciones sensibles
4. ‚úÖ **Inicializaci√≥n √∫nica**: Flag `initialized` previene reinicializaci√≥n
5. ‚úÖ **Validaci√≥n de arrays**: `sum(milestoneAmounts) == totalMilestonesAmount`
6. ‚úÖ **Comisi√≥n √∫nica**: La comisi√≥n de plataforma se cobra una sola vez al inicio del contrato

**Importante**: Estos contratos est√°n en fase de desarrollo. Se recomienda realizar una auditor√≠a de seguridad completa antes de usar en producci√≥n.

---

## üìù Licencia

MIT License

---

## ü§ù Contribuci√≥n

Para contribuir al proyecto:

1. Fork el repositorio
2. Crear branch: `git checkout -b feature/nueva-funcionalidad`
3. Commit cambios: `git commit -am 'Agrega nueva funcionalidad'`
4. Push: `git push origin feature/nueva-funcionalidad`
5. Crear Pull Request

### Est√°ndares de C√≥digo

- Solidity: Seguir [Solidity Style Guide](https://docs.soliditylang.org/en/latest/style-guide.html)
- Comentarios: NatSpec para todas las funciones p√∫blicas/externas
- Tests: Cobertura m√≠nima 80%
- Gas optimization: Usar `forge snapshot` para comparar antes/despu√©s

---

## üìû Soporte

Para preguntas o soporte:
- Email: ivestingo@gmail.com
- GitHub Issues: [ivestingo-contracts-escrow/issues](https://github.com/0xledgit/ivestingo-contracts-escrow/issues)

---

## üìö Referencias T√©cnicas

- [EIP-1167: Minimal Proxy Contract](https://eips.ethereum.org/EIPS/eip-1167)
- [OpenZeppelin Contracts](https://docs.openzeppelin.com/contracts/)
- [Foundry Book](https://book.getfoundry.sh/)
- [Polygon Amoy Testnet](https://polygon.technology/blog/introducing-the-amoy-testnet-for-polygon-pos)

---

**√öltima actualizaci√≥n**: 2025-01-26
**Versi√≥n**: 1.0.0 (Beta)